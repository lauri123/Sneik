name: Build Windows Portable

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: mvn clean package -B -DskipTests
      
    - name: Create portable Windows app image
      run: |
        echo "Creating portable Windows app image for Sneik..."
        
        # Check if JAR exists
        if (Test-Path "target\sneik-fat.jar") {
          $jarFile = "sneik-fat.jar"
        } elseif (Test-Path "target\sneik-1.0.0.jar") {
          $jarFile = "sneik-1.0.0.jar"
        } else {
          echo "ERROR: JAR file not found"
          exit 1
        }
        
        # Create short paths to avoid Windows path limits
        $inputDir = "C:\\jpkg-input"
        $tempDir = "C:\\jpkg-temp"
        
        if (Test-Path $inputDir) { Remove-Item -Recurse -Force $inputDir }
        if (Test-Path $tempDir) { Remove-Item -Recurse -Force $tempDir }
        
        New-Item -ItemType Directory -Force -Path $inputDir | Out-Null
        New-Item -ItemType Directory -Force -Path $tempDir | Out-Null
        
        # Copy only the JAR into a short path input dir
        Copy-Item -Path "target\$jarFile" -Destination $inputDir
        
        # Create output directory
        mkdir -p target\dist
        
        # Portable app image (no installer)
        jpackage `
          --type app-image `
          --input $inputDir `
          --dest target\dist `
          --name Sneik `
          --app-version 1.0.0 `
          --main-jar $jarFile `
          --main-class ee.itcollege.llaidna.Main `
          --vendor "Lauri123" `
          --description "A modern Java Snake game" `
          --java-options "-Xmx512m -Dfile.encoding=UTF-8" `
          --temp $tempDir `
          --verbose
        
    - name: Create portable ZIP
      run: |
        if (Test-Path "target\dist\Sneik") {
          Compress-Archive -Path target\dist\Sneik -DestinationPath target\dist\sneik-windows-portable.zip
        } else {
          echo "ERROR: App image not found"
          exit 1
        }
        
    - name: List build artifacts
      run: |
        echo "Build artifacts in target\dist:"
        if (Test-Path "target\dist") {
          Get-ChildItem target\dist -File | Select-Object Name, Length
          echo "Contents of target\dist:"
          dir target\dist
        }
        
    - name: Upload Windows Portable Build
      uses: actions/upload-artifact@v4
      with:
        name: sneik-windows-portable
        path: |
          target/dist/sneik-windows-portable.zip
        retention-days: 30
        
    - name: Upload Build Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          target/
          !target/**/*.class
        retention-days: 7