name: Build Windows Standalone - FIXED

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: mvn clean package -B -DskipTests
      
    - name: Create icon directory
      run: mkdir -p target/icons
      
    - name: Check for Main class
      run: |
        echo "Checking for main class in compiled JAR..."
        if (Test-Path "target/sneik-1.0.0.jar") {
          jar tf target/sneik-1.0.0.jar | findstr Main
        }
        
    - name: Create Windows installer with jpackage (SIMPLIFIED)
      run: |
        echo "Creating Windows installer for Sneik..."
        
        # Check if JAR exists
        if (-not (Test-Path "target\sneik-1.0.0.jar")) {
          echo "ERROR: JAR file not found"
          exit 1
        }
        
        # Create output directory
        mkdir -p target\dist
        
        # Simple jpackage command - no complex variables
        echo "Running jpackage..."
        
        jpackage `
          --type exe `
          --input target `
          --dest target\dist `
          --name Sneik `
          --app-version 1.0.0 `
          --main-jar sneik-1.0.0.jar `
          --main-class ee.itcollege.llaidna.Main `
          --vendor "Lauri123" `
          --copyright "Copyright 2026 Lauri123" `
          --description "A modern Java Snake game" `
          --win-shortcut `
          --win-menu `
          --java-options "-Xmx512m -Dfile.encoding=UTF-8" `
          --verbose
        
    - name: List build artifacts
      run: |
        echo "Build artifacts in target\dist:"
        if (Test-Path "target\dist") {
          Get-ChildItem target\dist -File | Select-Object Name, Length
          echo "Contents of target\dist:"
          dir target\dist
        }
        
    - name: Create test script
      run: |
        echo "@echo off" > target\dist\test-installation.bat
        echo "echo Testing Sneik installation..." >> target\dist\test-installation.bat
        echo "echo." >> target\dist\test-installation.bat
        echo "echo Checking installation directory..." >> target\dist\test-installation.bat
        echo "if exist \"C:\Program Files\Sneik\Sneik.exe\" (" >> target\dist\test-installation.bat
        echo "    echo [SUCCESS] Found executable at: C:\Program Files\Sneik\Sneik.exe" >> target\dist\test-installation.bat
        echo "    echo." >> target\dist\test-installation.bat
        echo "    echo Attempting to run Sneik..." >> target\dist\test-installation.bat
        echo "    \"C:\Program Files\Sneik\Sneik.exe\"" >> target\dist\test-installation.bat
        echo ") else (" >> target\dist\test-installation.bat
        echo "    echo [ERROR] Executable not found!" >> target\dist\test-installation.bat
        echo ")" >> target\dist\test-installation.bat
        echo "pause" >> target\dist\test-installation.bat
        
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: sneik-windows-installer-final
        path: |
          target/dist/*.exe
          target/dist/*.msi
          target/dist/test-installation.bat
        retention-days: 30
        
    - name: Upload Build Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          target/
          !target/**/*.class
        retention-days: 7